apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: bigtech-chat-ingress
  namespace: bigtech-chat
  labels:
    app: bigtech-chat
  annotations:
    # Nginx Ingress Controller
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, Accept"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # SSE Support
    nginx.ingress.kubernetes.io/proxy-buffering: "off"

    # TLS (uncomment when using cert-manager)
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  # TLS configuration (uncomment for HTTPS)
  # tls:
  #   - hosts:
  #       - api.bigtech-chat.com
  #     secretName: bigtech-chat-tls
  rules:
    - host: api.bigtech-chat.com
      http:
        paths:
          # User Service Routes
          - path: /api/auth
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005
          - path: /api/users
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005
          - path: /api/profile
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005

          # Friend Service Routes
          - path: /api/friends
            pathType: Prefix
            backend:
              service:
                name: friend-service
                port:
                  number: 8003

          # Chat Service Routes
          - path: /api/chat-rooms
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002
          - path: /api/messages
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002
          - path: /api/sse
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002

---
# Alternative: Kong Ingress Controller Configuration
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: bigtech-chat-ingress-kong
  namespace: bigtech-chat
  labels:
    app: bigtech-chat
  annotations:
    kubernetes.io/ingress.class: kong
    konghq.com/strip-path: "false"
    konghq.com/plugins: "cors-plugin,rate-limiting-plugin"
spec:
  rules:
    - host: api.bigtech-chat.com
      http:
        paths:
          - path: /api/auth
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005
          - path: /api/users
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005
          - path: /api/profile
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 8005
          - path: /api/friends
            pathType: Prefix
            backend:
              service:
                name: friend-service
                port:
                  number: 8003
          - path: /api/chat-rooms
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002
          - path: /api/messages
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002
          - path: /api/sse
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8002

---
# Kong Plugins (if using Kong Ingress Controller)
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: cors-plugin
  namespace: bigtech-chat
config:
  origins:
    - "*"
  methods:
    - GET
    - POST
    - PUT
    - DELETE
    - PATCH
    - OPTIONS
  headers:
    - Authorization
    - Content-Type
    - Accept
  credentials: true
  max_age: 3600
plugin: cors

---
apiVersion: configuration.konghq.com/v1
kind: KongPlugin
metadata:
  name: rate-limiting-plugin
  namespace: bigtech-chat
config:
  second: 10
  minute: 100
  hour: 1000
  policy: local
plugin: rate-limiting
