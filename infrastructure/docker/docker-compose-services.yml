version: '3.8'

# =============================================================================
# MSA Services Stack
# User Service, Friend Service, Chat Service
# =============================================================================

services:
  # =============================================================================
  # User Service (Port: 8005)
  # =============================================================================
  user-service:
    build:
      context: ../../services/user-service
      dockerfile: Dockerfile
    container_name: bigtech-user-service
    ports:
      - "8005:8005"
    environment:
      - APP_NAME=User Service
      - HOST=0.0.0.0
      - PORT=8005
      - DEBUG=false
      - MYSQL_URL=mysql+aiomysql://chatuser:chatpassword@mysql:3306/bigtech_chat
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-here}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_HOURS=2
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9093,kafka-3:9094
    depends_on:
      - mysql
      - redis
    networks:
      - bigtech-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Friend Service (Port: 8003)
  # =============================================================================
  friend-service:
    build:
      context: ../../services/friend-service
      dockerfile: Dockerfile
    container_name: bigtech-friend-service
    ports:
      - "8003:8003"
    environment:
      - APP_NAME=Friend Service
      - HOST=0.0.0.0
      - PORT=8003
      - DEBUG=false
      - MYSQL_URL=mysql+aiomysql://chatuser:chatpassword@mysql:3306/bigtech_chat
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-here}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_HOURS=2
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9093,kafka-3:9094
    depends_on:
      - mysql
    networks:
      - bigtech-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # Chat Service (Port: 8002)
  # =============================================================================
  chat-service:
    build:
      context: ../../services/chat-service
      dockerfile: Dockerfile
    container_name: bigtech-chat-service
    ports:
      - "8002:8002"
    environment:
      - APP_NAME=Chat Service
      - HOST=0.0.0.0
      - PORT=8002
      - DEBUG=false
      - MYSQL_URL=mysql+aiomysql://chatuser:chatpassword@mysql:3306/bigtech_chat
      - MONGO_URL=mongodb://admin:adminpassword@mongodb:27017
      - MONGODB_DB_NAME=bigtech_chat
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-here}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_HOURS=2
      - KAFKA_BOOTSTRAP_SERVERS=kafka-1:9092,kafka-2:9093,kafka-3:9094
      - KAFKA_TOPIC_MESSAGE_EVENTS=message.events
    depends_on:
      - mysql
      - mongodb
      - redis
    networks:
      - bigtech-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  bigtech-network:
    external: true
